<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Farmacia - Ejemplo XLS</title>
  
  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  
  <!-- SheetJS (XLSX) para leer archivos Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- QuaggaJS para escanear códigos de barras -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <!-- Estilos personalizados -->
  <style>
    /* Fondo tranquilo: verde pastel */
    body {
      background-color: #d7f0d6; /* Tonalidad verde claro/pastel */
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .container {
      width: 90%;
      margin: 20px auto;
      max-width: 1200px;
    }

    table {
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      padding: 8px;
      text-align: left;
    }

    /* Colores de resaltado al encontrar el producto / no encontrado */
    .found {
      background-color: #c8e6c9; /* Verde claro */
    }

    .not-found {
      background-color: #ffcdd2; /* Rojo claro */
    }

    /* Ajustes para inputs */
    .mdl-textfield {
      width: 100%;
    }

    /* Contenedor del escáner */
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
    }

    #interactive.viewport {
      position: relative;
      width: 100%;
    }

    #interactive video {
      width: 100%;
    }

    /* Botones con margen */
    .btn-margin {
      margin-right: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <h3>Inventario de Farmacia - Lectura de Excel (XLS/XLSX)</h3>

  <!-- Botón para subir archivo XLS/XLSX -->
  <input
    type="file"
    id="xlsFileInput"
    accept=".xls,.xlsx"
    class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent btn-margin"
  />

  <!-- Botón para iniciar/pausar el escaneo de códigos de barras -->
  <button
    id="startScannerBtn"
    class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"
  >
    Iniciar Escaneo
  </button>

  <!-- Tabla de productos -->
  <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" id="productsTable">
    <thead>
      <tr>
        <th>Código de barras</th>
        <th>Nombre</th>
        <th>Cantidad Sistema</th>
        <th>Cantidad Física</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas generadas dinámicamente -->
    </tbody>
  </table>

  <!-- Contenedor del escáner (cámara) -->
  <div id="scanner-container">
    <div id="interactive" class="viewport"></div>
  </div>
</div>

<script>
  let products = []; // Aquí guardaremos los datos leídos del XLS
  let scannerRunning = false;

  // Referencias a elementos del DOM
  const xlsFileInput = document.getElementById("xlsFileInput");
  const productsTableBody = document.querySelector("#productsTable tbody");
  const startScannerBtn = document.getElementById("startScannerBtn");

  /*
   * Lectura de archivos XLS/XLSX con SheetJS
   */
  xlsFileInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: "array" });

      // Por simplicidad, tomamos la primera hoja
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];

      // Convertimos la hoja a JSON
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      /*
       * Suponiendo que la primera fila (jsonData[0]) son los encabezados:
       *    [ 'codigo', 'nombre', 'cantidadSistema', ... ]
       * Y las siguientes filas tienen los valores correspondientes.
       * Ajusta la lógica según tus encabezados reales.
       */
      
      // Identificamos los índices de las columnas relevantes
      const headers = jsonData[0];
      const colCodigo = headers.indexOf("codigo");
      const colNombre = headers.indexOf("nombre");
      const colCantidadSistema = headers.indexOf("Cantidad Sistema");

      // Recorremos las filas (empezando en 1 para saltar encabezados)
      products = [];
      for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row || row.length === 0) continue; // fila vacía

        const codigo = row[colCodigo] || "";
        const nombre = row[colNombre] || "";
        const cantSis = row[colCantidadSistema] || 0;

        products.push({
          codigo: String(codigo).trim(),
          nombre: String(nombre),
          cantidadSistema: parseInt(cantSis, 10) || 0,
          cantidadFisica: 0,
          observaciones: "",
          encontrado: false
        });
      }
      renderTable();
    };
    reader.readAsArrayBuffer(file);
  });

  /*
   * Renderizar la tabla
   */
  function renderTable() {
    productsTableBody.innerHTML = "";
    products.forEach((prod, index) => {
      const row = document.createElement("tr");
      row.className = prod.encontrado ? "found" : "";

      // Código de barras
      const tdCodigo = document.createElement("td");
      tdCodigo.textContent = prod.codigo;
      row.appendChild(tdCodigo);

      // Nombre
      const tdNombre = document.createElement("td");
      tdNombre.textContent = prod.nombre;
      row.appendChild(tdNombre);

      // Cantidad en sistema
      const tdCantSistema = document.createElement("td");
      tdCantSistema.textContent = prod.cantidadSistema;
      row.appendChild(tdCantSistema);

      // Cantidad física (input)
      const tdCantFisica = document.createElement("td");
      const inputFisica = document.createElement("input");
      inputFisica.type = "number";
      inputFisica.value = prod.cantidadFisica;
      inputFisica.addEventListener("change", () => {
        prod.cantidadFisica = parseInt(inputFisica.value, 10) || 0;
      });
      tdCantFisica.appendChild(inputFisica);
      row.appendChild(tdCantFisica);

      // Observaciones (input)
      const tdObserv = document.createElement("td");
      const inputObs = document.createElement("input");
      inputObs.type = "text";
      inputObs.value = prod.observaciones;
      inputObs.addEventListener("change", () => {
        prod.observaciones = inputObs.value;
      });
      tdObserv.appendChild(inputObs);
      row.appendChild(tdObserv);

      productsTableBody.appendChild(row);
    });
  }

  /*
   * Iniciar / Detener escáner de código de barras
   */
  startScannerBtn.addEventListener("click", () => {
    if (!scannerRunning) {
      startScanner();
    } else {
      stopScanner();
    }
  });

  function startScanner() {
    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#interactive') // Contenedor
        },
        decoder: {
          readers: ["code_128_reader", "ean_reader", "upc_reader"]
        }
      },
      function(err) {
        if (err) {
          console.log(err);
          alert("Error al iniciar escáner: " + err);
          return;
        }
        Quagga.start();
        scannerRunning = true;
        startScannerBtn.textContent = "Detener Escaneo";
      }
    );

    // Evento cuando Quagga detecta un código
    Quagga.onDetected((data) => {
      const code = data.codeResult.code;
      console.log("Código detectado:", code);
      marcarEncontrado(code);
    });
  }

  function stopScanner() {
    Quagga.stop();
    scannerRunning = false;
    startScannerBtn.textContent = "Iniciar Escaneo";
  }

  /*
   * Marcar el producto como encontrado por su código
   */
  function marcarEncontrado(codigoLeido) {
    const foundIndex = products.findIndex(
      p => p.codigo.trim() === codigoLeido.trim()
    );
    if (foundIndex !== -1) {
      products[foundIndex].encontrado = true;
      // Opcional: al escanear, podríamos aumentar en 1 la cantidad física
      products[foundIndex].cantidadFisica += 1;
      renderTable();
    } else {
      alert("¡Producto no encontrado en la lista!");
    }
  }
</script>
</body>
</html>
