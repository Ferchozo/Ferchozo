<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Farmacia - Ejemplo</title>
  <!-- Material Design Lite -->
  <link
    rel="stylesheet"
    href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"
  />
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <!-- QuaggaJS para el escaneo de códigos de barras -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <style>
    .container {
      width: 90%;
      margin: 20px auto;
    }
    table {
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .found {
      background-color: #c8e6c9; /* Verde claro para indicar encontrado */
    }
    .not-found {
      background-color: #ffcdd2; /* Rojo claro para indicar no encontrado */
    }
    .mdl-textfield {
      width: 100%;
    }
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
    }
    #interactive.viewport {
      position: relative;
      width: 100%;
    }
    #interactive video {
      width: 100%;
    }
  </style>
</head>
<body>

<div class="container">

  <h3>Inventario Farmacia (Ejemplo) </h3>

  <!-- Botón para subir CSV -->
  <input
    type="file"
    id="csvFileInput"
    accept=".csv"
    class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"
  />
  
  <!-- Contenedor de tabla -->
  <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" id="productsTable">
    <thead>
      <tr>
        <th>Código de barras</th>
        <th>Nombre</th>
        <th>Cantidad Sistema</th>
        <th>Cantidad Física</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Se rellena dinámicamente -->
    </tbody>
  </table>

  <!-- Botón para iniciar/pausar el escaneo -->
  <button
    id="startScannerBtn"
    class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"
  >
    Iniciar Escaneo
  </button>

  <!-- Contenedor para el escáner QuaggaJS -->
  <div id="scanner-container">
    <div id="interactive" class="viewport"></div>
  </div>

</div>

<script>
  let products = []; // Array donde guardamos la información del CSV
  let scannerRunning = false;

  // Referencias a elementos del DOM
  const csvFileInput = document.getElementById("csvFileInput");
  const productsTableBody = document.querySelector("#productsTable tbody");
  const startScannerBtn = document.getElementById("startScannerBtn");

  // Cargar y parsear CSV
  csvFileInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true, // Asume que la primera fila es cabecera
      complete: function(results) {
        // results.data es un array de objetos
        products = results.data.map((prod, idx) => {
          return {
            codigo: prod["codigo"] || "",
            nombre: prod["nombre"] || "",
            cantidadSistema: prod["cantidadSistema"] || 0,
            cantidadFisica: 0,
            observaciones: "",
            encontrado: false
          };
        });
        renderTable();
      },
      error: function(err) {
        console.error("Error al leer el CSV:", err);
      }
    });
  });

  // Función para mostrar la tabla en el HTML
  function renderTable() {
    productsTableBody.innerHTML = "";
    products.forEach((prod, index) => {
      const row = document.createElement("tr");
      row.className = prod.encontrado ? "found" : "";

      // Código de barras
      const tdCodigo = document.createElement("td");
      tdCodigo.textContent = prod.codigo;
      row.appendChild(tdCodigo);

      // Nombre
      const tdNombre = document.createElement("td");
      tdNombre.textContent = prod.nombre;
      row.appendChild(tdNombre);

      // Cantidad en sistema
      const tdCantSistema = document.createElement("td");
      tdCantSistema.textContent = prod.cantidadSistema;
      row.appendChild(tdCantSistema);

      // Cantidad física (input)
      const tdCantFisica = document.createElement("td");
      const inputFisica = document.createElement("input");
      inputFisica.type = "number";
      inputFisica.value = prod.cantidadFisica;
      inputFisica.addEventListener("change", () => {
        prod.cantidadFisica = inputFisica.value;
      });
      tdCantFisica.appendChild(inputFisica);
      row.appendChild(tdCantFisica);

      // Observaciones (input)
      const tdObserv = document.createElement("td");
      const inputObs = document.createElement("input");
      inputObs.type = "text";
      inputObs.value = prod.observaciones;
      inputObs.addEventListener("change", () => {
        prod.observaciones = inputObs.value;
      });
      tdObserv.appendChild(inputObs);
      row.appendChild(tdObserv);

      productsTableBody.appendChild(row);
    });
  }

  // Iniciar o pausar el escáner
  startScannerBtn.addEventListener("click", () => {
    if (!scannerRunning) {
      startScanner();
    } else {
      stopScanner();
    }
  });

  function startScanner() {
    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#interactive') // ID del contenedor
        },
        decoder: {
          readers: ["code_128_reader", "ean_reader", "upc_reader"]
        }
      },
      function(err) {
        if (err) {
          console.log(err);
          alert("Error al iniciar el escáner: " + err);
          return;
        }
        Quagga.start();
        scannerRunning = true;
        startScannerBtn.textContent = "Detener Escaneo";
      }
    );

    // Cuando Quagga detecta un código
    Quagga.onDetected((data) => {
      const code = data.codeResult.code;
      console.log("Código detectado:", code);
      marcarEncontrado(code);
    });
  }

  function stopScanner() {
    Quagga.stop();
    scannerRunning = false;
    startScannerBtn.textContent = "Iniciar Escaneo";
  }

  // Marca el producto como encontrado en la lista si coincide el código
  function marcarEncontrado(codigoLeido) {
    const foundIndex = products.findIndex(p => p.codigo.trim() === codigoLeido.trim());
    if (foundIndex !== -1) {
      products[foundIndex].encontrado = true;
      // Para ejemplificar, incrementamos en 1 la cantidad física cada vez que se escanea
      products[foundIndex].cantidadFisica = parseInt(products[foundIndex].cantidadFisica || 0) + 1;
      renderTable();
    } else {
      alert("¡Producto no encontrado en la lista!");
    }
  }
</script>
</body>
</html>
